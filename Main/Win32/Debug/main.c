/* 
 * File:   main.c
 * Author: PascalPicCreator v. Alpha
 */


#include <xc.h>
#include <sys/attribs.h>
#include <p32xxxx.h>      
#include "init.h"
#include "pasapi.h"
#define _PROTOCOL_24D_
//---------------------------------------------------------------------
// Configuration bits
//---------------------------------------------------------------------
/*** DEVCFG0 ***/
#pragma config DEBUG =      OFF             // ??????? ????????
#pragma config JTAGEN =     OFF             // JTAG ????????
#pragma config ICESEL =     ICS_PGx2        // ????????? PGEC2/PGED2
#pragma config TRCEN =      OFF             // Trace features in the CPU ????????
#pragma config BOOTISA =    MIPS32          // Boot code and Exception code is MIPS32
#pragma config FECCCON =    OFF_UNLOCKED    // ECC and Dynamic ECC are disabled (ECCCON bits are writable)
#pragma config FSLEEP =     OFF             // Flash is powered down when the device is in Sleep mode
#pragma config DBGPER =     ALLOW_PG2       // PG_ALL ????????? ?? ????? // PG_NONE ?????????// ????????? ?????? ???????????? ?????????? ? ?????????? ?????? 2 ?????????? ????????
/* ????? ????? ?????????? ??????????
#pragma config SMCLR =      MCLR_NORM       //	MCLR pin generates a normal system Reset

#pragma config POSCGAIN =   GAIN_2X         // ????????? ???????? 2x // GAIN_LEVEL_0 -??????? ???????? 0 (????? ??????)
#pragma config POSCBOOST =  ON              // ????????????? ?????? ?????????? OFF - ?????????? ?????? ??????????

#pragma config SOSCGAIN =   GAIN_2X         // ????????? ???????? 2x // GAIN_LEVEL_0 - ??????? ???????? 0 (????? ??????)
#pragma config SOSCBOOST =  ON              // ????????????? ?????? ?????????? OFF - ?????????? ?????? ??????????

 */
#pragma config EJTAGBEN =   NORMAL          // ?????????? ???????????????? EJTAG
#pragma config CP =         OFF             // ?????? ???? ????????? ???????? !!!


/*** DEVCFG1 ***/
#pragma config IESO =       OFF              // ???? ?????????? ?????? ????????

#pragma config FNOSC =      SPLL            // ????? ???????? ??????? ????? ??????????


#pragma config FSOSCEN =    OFF             // ????????? ????????? SOSC ????????

#pragma config OSCIOFNC =   OFF             // CLKO ???????? ?????? ???????? ?? OSCO Pin ????????


#pragma config FCKSM =      CSECMD          // ???????????? ??????????? ?????????, FSCM Disabled

#pragma config WDTPS =      PS1048576       // PS32768 - 1:32768
#pragma config WDTSPGM =    STOP            // WDT ??????????????? ?? ????? ???????????????? ????
#pragma config FWDTEN =     ON              // ?????????? ?????? ???????
#pragma config WINDIS =     NORMAL          // Watchdog Timer is in non-Window mode

#pragma config FWDTWINSZ =  WINSZ_75        // Window size is 75%
#pragma config DMTINTV =    WIN_127_128     // ???? ???????? ???????? 127/128 ???????? ???????? // WIN_0 - Window/Interval value is zero
#pragma config DMTCNT =     DMT9            // ????? ?????? ????????? 2^9 (512)
#pragma config FDMTEN =     OFF             // Deadman Timer ????????



/*** DEVCFG3 ***/
#pragma config USERID =     0xffff          // Range is from 0 to 0xffff
#pragma config FMIIEN =     OFF             // RMII Enabled
#pragma config FETHIO =     OFF             // ?????????????? Ethernet I/O
#pragma config PGL1WAY =    OFF             // ????????? ????????? ????????????????
#pragma config PMDL1WAY =   OFF             // ????????? ????????? ????????????????
#pragma config IOL1WAY =    OFF             // ????????? ????????? ????????????????

#pragma config FUSBIDIO =   OFF             // ??????????? ???? ???????


/*** USERDEV ***/
#pragma config POSCMOD =    EC              // External Clock 
#pragma config UPLLFSEL =   FREQ_24MHZ
#pragma config FPLLICLK =   PLL_POSC
#pragma config FPLLRNG =    RANGE_21_42_MHZ
#pragma config FPLLIDIV =   DIV_2
#pragma config FPLLMULT =    MUL_33
#pragma config FPLLODIV =   DIV_2
#define LED_RED  PORTBbits.RB9
#define LED_GRN  PORTBbits.RB4
#define TIME_COUNT   10
#define BRSETUP   9600
#define BRSETUP3   115200
#define BRWORK   115200
unsigned char RedState ;
unsigned char GreenState ;
unsigned char Command1 ;
unsigned char Command2 ;
unsigned char Stage ;
unsigned char i ;
unsigned char ComportPos ;
unsigned char ComportLast ;
int TimeCount ;
int TryFailed ;
char AT [3]="AT";
char HC06_115200 [32]="AT+BAUD8";
unsigned char ComportBuffer [99+1];
int Timer1_maxcount = 0;
int Timer1_tail = 61875;
int Timer1_counter = 0;
int Timer2_maxcount = 47;
int Timer2_tail = 13558;
int Timer2_counter = 0;
unsigned char RX_0;
int main(int argc, char** argv);
void __ISR(0, ipl1) InterruptHandler(void);
void ToWork(void);
int main(int argc, char** argv)
{
  Init();
  for (i = 0 ;i <= 10 ;i++)
  {
  RedState   = 0;
  GreenState = 0;
  Command1   = 0;
  Command2   = 0;
  TimeCount  = 0;
  TryFailed  = 0;
  Stage      = 3;
  ComportPos = 0;
  ComportLast = 0;
    LED_RED = 1;
  ChangePort(0);
  }
  while (1){
  //FastRx(0,Command1);
  Command1 = ComportBuffer[ComportPos];
  ComportPos++;
  if ( ComportPos>ComportLast ) 
  {
      ComportPos = 0;
      ComportLast = 0;
  }
  if ( (Command1==0x4B) && (Command2==0x4F) )   //OK   Command1=K(75)    Command2=O(79)
  {
    if ( Stage<2 ) 
    Stage++;
      Command1 = 0 ;
    switch ( Stage ) {
     case  1:
    {
      LED_GRN = 1;
            TryFailed = 0;
    }
    break;
     case  2: ToWork(); //ToWork->ToWork()
    break;
     case  3:
    {
          Stage = 2;
          ToWork();
    }
  }
  }
  Command2 = Command1;
  if ( (Stage==0) || (Stage==3) )     // and ->&&  This string is test of comments.
  if ( TimeCount>==TIME_COUNT ) 
  {
        TransferStr(AT);
        TimeCount = 0;
    TryFailed++;
    if ( TryFailed>10 ) 
    {
            TryFailed = 0;
      if ( Stage==3 ) 
      {
                Stage = 0;
                InitUART(0,BRSETUP);
      }
            else
      {
               Stage = 3;
               InitUART(0,BRSETUP3);
      }
    }
  }
  if ( (Stage==1) && (TimeCount>TIME_COUNT) ) 
  {
      TransferStr(HC06_115200);  //Раз в 0,05 с.
      TimeCount = 0;
    TryFailed++;
    if ( TryFailed>10 ) 
    {
          TryFailed = 0;
          Stage = 3;
          InitUART(0,BRSETUP3);
    }
  }
}
  return (EXIT_SUCCESS);
}
void __ISR(0, ipl1) InterruptHandler(void)
{
if ((IFS0bits.T2IF) && (IEC0bits.T2IE)) {
IFS0bits.T2IF = 0;
Timer1_counter++;
if (Timer1_counter <= Timer1_maxcount)
  if (Timer1_counter == Timer1_maxcount) TMR2 = 3661;
  else TMR2 = 3661;
else 
{
Timer1_counter = 0;
TMR2 = 3661;
//User code
  TimeCount++;
}
}
if ((IFS0bits.T3IF) && (IEC0bits.T3IE)) {
IFS0bits.T3IF = 0;
Timer2_counter++;
if (Timer2_counter <= Timer2_maxcount)
  if (Timer2_counter == Timer2_maxcount) TMR3 = 51978;
  else TMR3 = 0;
else 
{
Timer2_counter = 0;
TMR3 = 0;
//User code
  //SetBit(LED_GRN,GreenState);
  GreenState = GreenState ^ 1;
}
}
if ((U1STAbits.OERR)||(U1STAbits.FERR)) {
  U1STAbits.URXEN = 0;
  U1STAbits.URXEN = 1;
}
if (IFS3bits.U1RXIF) while (U1STAbits.URXDA)
{
RX_0 = U1RXREG;
//User code
  ComportBuffer[ComportLast] = RX_0;
  ComportLast++;
  //FastTx(0,'F');
  //SetBit(LED_GRN,1);
}
}
void ToWork(void)
{
  LED_RED = 0;
  InitUART(0,BRWORK);
}
